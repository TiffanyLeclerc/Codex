<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>更正作業 - 請領核發資料 (op6_edit4.html)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <style>
      body { background-color: #fff; }
      .card-header { display: flex; justify-content: space-between; align-items: center; }
      .btn-toolbar { justify-content: flex-end; }
      .col-form-label .required { color: red; font-weight: bold; margin-right: 2px; }
      .form-text-display { padding-top: 0; padding-bottom: 0; margin-bottom: 0; font-size: 1rem; line-height: 1.4; color: #212529; font-weight: bold; min-height: 0; display: inline; }
      .col-form-label:not(.no-colon)::after { content: '：'; }
      .form-control.size-auto, .form-select.size-auto, .input-group.size-auto { width: auto; display: inline-flex; }
      .nav-tabs { flex-wrap: nowrap; overflow-x: auto; overflow-y: hidden; }
      .nav-tabs .nav-link { white-space: nowrap; }
      .demo-switcher { background-color: #fff3cd; border: 1px solid #ffeeba; }
      .error-message { color: red; font-size: 0.875em; margin-top: 0.25rem; display: block; width: 100%; }
      .table-responsive { margin-top: 1rem; }
      .table th, .table td { vertical-align: middle; text-align: center; }
      .table thead th hr { margin: 0.25rem 0; border-color: inherit; opacity: 0.25; }
      
      .form-field-container { display: flex; align-items: baseline; width: 100%; gap: 0; }
      .form-field-container .col-form-label { flex-shrink: 0; text-align: left; padding-right: 0; white-space: nowrap; min-width: auto; }
      .form-field-container .field-content { flex-grow: 1; }
      
      /* 三欄彈性排版 */
      .flex-form-container { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); column-gap: 16px; row-gap: 8px; margin: 0; }
      .flex-form-item { box-sizing: border-box; padding: 0; margin: 0; }
      
      .card-body { padding-bottom: 2.5rem; }
      
      .issuance-section-title {
          font-weight: bold;
          margin-top: 1.5rem;
          margin-bottom: 0.5rem;
      }
      .issuance-section-title .required {
          color: red;
      }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <div id="modification-page">
            <div class="card">
                <div class="card-header">
                    <h2 class="mb-0">更正作業</h2>
                    <div id="common-buttons" class="btn-toolbar" role="toolbar">
                        <button id="btn-confirm" type="button" class="btn btn-primary me-2"><i class="bi bi-check-circle"></i> 確認</button>
                        <button id="btn-print-checklist" type="button" class="btn btn-info me-2" disabled><i class="bi bi-printer"></i> 受理審核清單列印</button>
                        <button id="btn-prepare-approval" type="button" class="btn btn-success me-2"><i class="bi bi-send-check"></i> 審核</button>
                        <button id="btn-split-amount" type="button" class="btn btn-warning me-2"><i class="bi bi-distribute-vertical"></i> 金額分割</button>
                        <button id="btn-print-pdf" type="button" class="btn btn-light border me-2"><i class="bi bi-file-earmark-pdf"></i> 頁面(或pdf)列印</button>
                        <button id="btn-return" type="button" class="btn btn-secondary"><i class="bi bi-arrow-left-circle"></i> 返回</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="p-3 mb-3 rounded demo-switcher">
                        <div class="row align-items-center">
                            <div class="col-auto"><strong class="text-danger"><i class="bi bi-tools"></i> 情境快速切換器 (Demo專用)</strong></div>
                            <div class="col-auto"><label for="demoClaimTypeSwitcher" class="col-form-label">切換請領種類查看介面變化</label></div>
                            <div class="col-auto"><select id="demoClaimTypeSwitcher" class="form-select size-auto"></select></div>
                        </div>
                    </div>
                    
                    <div class="p-3 mb-3 border bg-white rounded">
                         <div class="form-field-container">
                            <label class="col-form-label">請領種類</label>
                            <div class="field-content"><p id="display-claim-type" class="form-text-display mb-0"></p></div>
                        </div>
                    </div>

                    <ul class="nav nav-tabs" id="myTab" role="tablist">
                        <li class="nav-item" role="presentation"><a class="nav-link" id="tab-basic" href="op6_edit.html">基本資料</a></li>
                        <li class="nav-item" role="presentation"><a class="nav-link" id="tab-beneficiary" href="op6_edit2.html">受款人</a></li>
                        <li class="nav-item" role="presentation"><a class="nav-link" id="tab-approval-letter" href="op6_edit3.html">核定函</a></li>
                        <li class="nav-item" role="presentation"><a class="nav-link active" id="tab-issuance-data" href="op6_edit4.html">請領核發資料</a></li>
                        <li class="nav-item" role="presentation"><a class="nav-link" id="tab-other-benefits" href="op6_edit5.html">請領其他給付資料</a></li>
                        <li class="nav-item" role="presentation"><a class="nav-link" id="tab-pension-changes" href="op6_edit6.html">勞退個人異動查詢</a></li>
                        <li class="nav-item" role="presentation"><a class="nav-link" id="tab-account-details" href="op6_edit7.html">個人專戶明細資料</a></li>
                        <li class="nav-item" role="presentation"><a class="nav-link" id="tab-case-notes" href="op6_edit8.html">案件記事</a></li>
                    </ul>

                    <div class="tab-content border border-top-0 p-3" id="myTabContent">
                        <div class="tab-pane fade show active" id="pane-issuance-data" role="tabpanel">
                            
                            <div class="p-3 mb-4">
                                <div class="flex-form-container">
                                    <div class="flex-form-item"><div class="form-field-container"><label class="col-form-label">受理編號</label><div class="field-content"><p id="display-case-id" class="form-text-display"></p></div></div></div>
                                    <div class="flex-form-item"><div class="form-field-container"><label class="col-form-label">勞工姓名</label><div class="field-content"><p id="display-laborer-name" class="form-text-display"></p></div></div></div>
                                    <div class="flex-form-item"><div class="form-field-container"><label class="col-form-label">勞工身分證字號</label><div class="field-content"><p id="display-laborer-id" class="form-text-display"></p></div></div></div>
                                    <div class="flex-form-item"><div class="form-field-container"><label class="col-form-label">勞工出生日期</label><div class="field-content"><p id="display-laborer-dob" class="form-text-display"></p></div></div></div>
                                    <div class="flex-form-item"><div class="form-field-container"><label class="col-form-label">版次</label><div class="field-content"><p id="display-version" class="form-text-display"></p></div></div></div>
                                    <div class="flex-form-item"></div>
                                </div>
                            </div>

                            <div id="issuance-once-section">
                                <h5 class="issuance-section-title"><span class="required">*</span>請領一次退休金記錄：</h5>
                                <div class="table-responsive">
                                    <table class="table table-bordered table-sm">
                                        <thead class="table-light">
                                            <tr>
                                                <th>申請日期<hr>核發日期</th>
                                                <th>受理日期<hr>核定金額</th>
                                                <th><span class="death-date-col-part">死亡日期<hr></span><span>實發金額</span></th>
                                                <th>受理編號<hr>補發金額</th>
                                                <th>請領人姓名<hr>補件日期-註記</th>
                                                <th>提繳年資<hr>不予核發日期-原因</th>
                                                <th>核定日期<hr>其他註記</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>105/08/22<br>105/08/30</td>
                                                <td>105/08/24<br>208538</td>
                                                <td><span class="death-date-col-part">&nbsp;<br></span><span>208538</span></td>
                                                <td>105041044420<br>&nbsp;</td>
                                                <td class="issuance-applicant-name">&nbsp;<br>&nbsp;</td>
                                                <td>7年7月<br>&nbsp;</td>
                                                <td>105/08/26<br>&nbsp;</td>
                                            </tr>
                                            <tr>
                                                <td>105/08/22<br>105/12/12</td>
                                                <td>105/08/24<br>10944</td>
                                                <td><span class="death-date-col-part">&nbsp;<br></span><span>10944</span></td>
                                                <td>10504104442001<br>&nbsp;</td>
                                                <td class="issuance-applicant-name">&nbsp;<br>&nbsp;</td>
                                                <td>0年3月<br>&nbsp;</td>
                                                <td>105/12/08<br>&nbsp;</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div id="issuance-monthly-section">
                                <h5 class="issuance-section-title"><span class="required">*</span>請領月退休金記錄：</h5>
                                <div class="table-responsive">
                                    <table class="table table-bordered table-sm">
                                        <thead class="table-light">
                                            <tr>
                                                <th>申請日期<hr>核發日期</th>
                                                <th><span class="received-date-col-part">本局收到日期<hr></span><span>首發核定金額</span></th>
                                                <th>受理日期<hr>實發金額</th>
                                                <th>受理編號<hr>補件日期-註記</th>
                                                <th>核定起迄年月<hr>不給付日期-原因</th>
                                                <th>月退休金金額<hr>其他註記</th>
                                                <th>核定日期<hr>結案日期</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                             <tr>
                                                <td>107/08/13<br>107/08/21</td>
                                                <td><span class="received-date-col-part">107/08/16<br></span><span>80128</span></td>
                                                <td>&nbsp;<br>80128</td>
                                                <td>107043010784<br>&nbsp;</td>
                                                <td>&nbsp;<br>&nbsp;</td>
                                                <td>&nbsp;<br>&nbsp;</td>
                                                <td>107/08/17<br>&nbsp;</td>
                                             </tr>
                                            <tr>
                                                <td>107/08/13<br>107/11/22</td>
                                                <td><span class="received-date-col-part">107/08/16<br></span><span>10944</span></td>
                                                <td>&nbsp;<br>10944</td>
                                                <td>10704301078401<br>&nbsp;</td>
                                                <td>&nbsp;<br>&nbsp;</td>
                                                <td>&nbsp;<br>&nbsp;</td>
                                                <td>107/11/20<br>&nbsp;</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const urlParams = new URLSearchParams(window.location.search);
        const claimTypeFromUrl = urlParams.get('claimType');
        const caseIdFromUrl = urlParams.get('caseId');
        const caseIdCanonical = caseIdFromUrl || (function(){ try { return sessionStorage.getItem('op6_current_case_id'); } catch(e){ return null; } })() || 'demo_case_01';
        const storageKey = `op6_edit_state_${caseIdCanonical}`;

        const claimTypeMap = {
            '31': '提前請領退休金(31)', '32': '提前請領月退休金(32)', '41': '一次退休金(41)',
            '42': '月退休金(42)', '43': '續提退休金(43)', '46': '續提月退休金(46)',
            '51': '死亡退休金(51)', '52': '月退死亡退休金(52)', '53': '死亡退休金(含月退)(53)'
        };
        const demoSwitcher = document.getElementById('demoClaimTypeSwitcher');
        let state = {};

        // Populate switcher
        for (const key in claimTypeMap) {
            const option = document.createElement('option');
            option.value = key;
            option.textContent = claimTypeMap[key];
            demoSwitcher.appendChild(option);
        }

        function defaultStateForClaim(claimType, caseId) {
            return {
                demoClaimType: claimType || '53',
                caseId: caseId || '',
                laborerName: '王大明',
                laborerId: 'A123456789',
                laborerDob: '0600101',
                version: '1'
            };
        }

        function loadState() {
            const savedStateJSON = sessionStorage.getItem(storageKey);
            if (!savedStateJSON) {
                state = defaultStateForClaim(claimTypeFromUrl || '53', caseIdFromUrl);
            } else {
                let loaded = JSON.parse(savedStateJSON);
                // 以 URL 參數為準，覆蓋暫存類別/受理編號
                if (claimTypeFromUrl && loaded.demoClaimType !== claimTypeFromUrl) {
                    loaded.demoClaimType = claimTypeFromUrl;
                }
                if (caseIdFromUrl) { loaded.caseId = caseIdFromUrl; }
                state = { ...defaultStateForClaim(loaded.demoClaimType, loaded.caseId), ...loaded };
            }
            try { sessionStorage.setItem(storageKey, JSON.stringify(state)); } catch(e) {}
            try { sessionStorage.setItem('op6_current_case_id', state.caseId || caseIdFromUrl || 'demo_case_01'); } catch(e) {}
        }

        function saveState() {
            sessionStorage.setItem(storageKey, JSON.stringify(state));
        }

        function formatCaseId(val) {
            const s = (val || '').toString();
            if (!s) return '';
            const parts = s.split('-');
            for (let i = parts.length - 1; i >= 0; i--) {
                if (parts[i] === '' || parts[i] === undefined || parts[i] === null) { parts.pop(); } else { break; }
            }
            return parts.join('-');
        }

        function updateUI() {
            const currentClaimType = state.demoClaimType || '53';
            demoSwitcher.value = currentClaimType;

            // Update header fields
            document.getElementById('display-claim-type').textContent = claimTypeMap[currentClaimType] || '未知';
            // 優先使用 state.caseId，其次使用 URL 參數
            if (!state.caseId && caseIdFromUrl) { state.caseId = caseIdFromUrl; }
            document.getElementById('display-case-id').textContent = formatCaseId(state.caseId || '');
            document.getElementById('display-laborer-name').textContent = state.laborerName || '王大明';
            document.getElementById('display-laborer-id').textContent = state.laborerId || 'A123456789';
            document.getElementById('display-laborer-dob').textContent = state.laborerDob || '0600101';
            document.getElementById('display-version').textContent = state.version || '1';

            // Update table conditional columns
            const deathClaimTypesForColumn = ['51', '52', '53'];
            const showDeathDateColumn = deathClaimTypesForColumn.includes(currentClaimType);
            document.querySelectorAll('.death-date-col-part').forEach(el => {
                el.style.display = showDeathDateColumn ? 'inline' : 'none';
            });

            const receivedDateClaimTypes = ['32', '42', '46', '52', '53'];
            const showReceivedDateColumn = receivedDateClaimTypes.includes(currentClaimType);
            document.querySelectorAll('.received-date-col-part').forEach(el => {
                el.style.display = showReceivedDateColumn ? 'inline' : 'none';
            });
            
            // Update applicant name in table
            document.querySelectorAll('.issuance-applicant-name').forEach(cell => {
                cell.innerHTML = `${state.laborerName || '王大明'}<br>&nbsp;`;
            });

            // Update button visibility
            updateButtonsForTab(document.querySelector('#myTab .nav-link.active')?.id, currentClaimType);
            
            // Update tab links
            updateTabLinks();
        }
        
        function updateButtonsForTab(activeTabId, currentClaimType) {
            const isEditableTab = ['tab-basic', 'tab-beneficiary', 'tab-case-notes'].includes(activeTabId);
            document.getElementById('btn-confirm').style.display = isEditableTab ? '' : 'none';
            document.getElementById('btn-print-checklist').style.display = isEditableTab ? '' : 'none';
            document.getElementById('btn-prepare-approval').style.display = isEditableTab ? '' : 'none';
            document.getElementById('btn-print-pdf').style.display = !isEditableTab ? '' : 'none';
            document.getElementById('btn-split-amount').style.display = 'none';
        }
        
        function updateTabLinks() {
            const currentCaseId = state.caseId || caseIdFromUrl || '';
            const currentClaimType = state.demoClaimType || claimTypeFromUrl || '';

            document.querySelectorAll('#myTab .nav-link').forEach(tabLink => {
                const baseHref = tabLink.getAttribute('href').split('?')[0];
                if (baseHref === '#' || !baseHref) return;
                
                const params = new URLSearchParams();
                if (currentClaimType) params.set('claimType', currentClaimType);
                if (currentCaseId) params.set('caseId', currentCaseId);
                
                if (state.civilLawCase) params.set('isCivilLawCase', state.civilLawCase);
                if (state.deathDate) params.set('deathDate', state.deathDate);

                tabLink.setAttribute('href', `${baseHref}?${params.toString()}`);
            });
        }

        // Event Listeners
        demoSwitcher.addEventListener('change', function() {
            state.demoClaimType = this.value;
            saveState();
            updateUI();
        });

        document.getElementById('btn-return').addEventListener('click', () => {
            try {
                const saved = JSON.parse(sessionStorage.getItem(storageKey) || '{}');
                const ct = saved.demoClaimType || demoSwitcher.value || '';
                const cid = caseIdFromUrl || 'N/A';
                const params = new URLSearchParams();
                if (ct) params.set('claimType', ct);
                if (cid) params.set('caseId', cid);
                const suffix = params.toString();
                window.location.href = suffix ? `op6.html?${suffix}` : 'op6.html';
            } catch (e) { window.location.href = 'op6.html'; }
        });
        
        document.getElementById('btn-print-pdf').addEventListener('click', () => window.print());
        
        // 審核 提示（含跨頁籤 dirty 與是否已確認檢核）
        const btnPrepare = document.getElementById('btn-prepare-approval');
        if (btnPrepare) {
            btnPrepare.addEventListener('click', () => {
                try {
                    const crossTabDirty = sessionStorage.getItem('op6_edit_dirty_any') === 'true';
                    const saved = JSON.parse(sessionStorage.getItem(storageKey) || '{}');
                    const hasConfirmed = !!saved.isReAdjudicated;
                    if (crossTabDirty || !hasConfirmed) {
                        alert('版本不一致，無法進行初核核定。請先按下「確認」完成重新編審。');
                        return;
                    }
                } catch(e) {}
                if (confirm('是否確認進行審核？')) {
                    alert('已送出審核。');
                }
            });
        }

        // Initial Load
        loadState();
        updateUI();
    });
    </script>
</body>
</html>
